# R code for the main model in the paper #
# Experience of discrimination during COVID-19 pandemic: the impact of public health measures and psychological distress among refugees and other migrants in Europe #
# R code by Mattia Marchi (mattiamarchimd@gmail.com) 
# February 14, 2022


#-------------------------------------------------------------
#-------------1. Load the required packages-------------------
#-------------------------------------------------------------

# install.packages("lavaan") # run if not already installed
library(lavaan)
# install.packages("tidySEM") # run if not already installed
library(tidySEM)
# install.packages("semTools") # run if not already installed
library(semTools)

#--------------------------------------------------------------
#-------------2. Reproduce the var/cov matrix------------------
#--------------------------------------------------------------

lower <- '0.421302549
          0.342210267	0.355208555
          0.331142421	0.309944739	0.335972013
          0.36871511	0.340515327	0.335120256	0.424087972
          0.356829838	0.32961916	0.327928287	0.375727715	0.400775646
          0.314953593	0.295677679	0.296991401	0.321665916	0.317754082	0.320861085
          0.301822053	0.276088495	0.269156507	0.290214051	0.281912887	0.265740606	0.855495689
          0.330623999	0.305864945	0.294922405	0.316225125	0.312506109	0.29025303	0.62798549	1.05652201
          0.360741236	0.342241488	0.326960713	0.355041612	0.351354209	0.326368357	0.626681124	0.70239092	1.177973496
          0.371727782	0.342424398	0.335717538	0.362705528	0.354905454	0.326768999	0.600471464	0.733653963	0.710509465	1.202210742
          0.455640895	0.435774964	0.422701769	0.454535376	0.448511905	0.413521449	0.681096117	0.807177694	0.900825158	0.95537041	1.518614157
          0.428753497	0.396853381	0.385789923	0.417957182	0.408577405	0.37747763	0.542026437	0.608834431	0.675192068	0.684134054	0.845616333	0.867044112
          0.675308787	0.634093805	0.616240575	0.671842488	0.657846436	0.610533338	0.689625504	0.776246227	0.845459458	0.875331387	1.084398614	1.010146122	2.542620696
          0.642669871	0.611084434	0.59423013	0.647491065	0.636715772	0.593353589	0.685170361	0.776406037	0.854261088	0.871726693	1.091544283	0.992964136	2.100977509	2.587448363
          0.66682727	0.630440587	0.612027442	0.67222667	0.655843586	0.612114233	0.692024827	0.796875089	0.863325996	0.906442509	1.128872971	1.015715937	2.130096836	2.167956805	2.609362442
          0.639613687	0.605584049	0.590725839	0.640171771	0.629674867	0.585018908	0.658795342	0.753155658	0.806496222	0.846302424	1.073078037	0.968897101	2.003980436	1.944006292	1.978071189	2.435792631
          0.654424898	0.614119175	0.590778562	0.653622538	0.643170438	0.585431144	0.661729737	0.755429313	0.820006206	0.826577024	1.041139232	0.934923601	1.839558924	1.774015111	1.858413362	1.803172633	2.216141577
          0.646511853	0.607728447	0.590881785	0.650978517	0.643419974	0.583498799	0.643237166	0.732290685	0.787655877	0.834237948	1.052384844	0.925273731	1.840360544	1.803670687	1.901355043	1.8198312	1.838418233	2.26994107
          0.625491807	0.587727332	0.568887248	0.636237491	0.622841568	0.565540864	0.629321222	0.70821043	0.772703161	0.789018152	0.986884775	0.88566883	1.729566237	1.664816648	1.753558567	1.715221509	1.750365005	1.748404141	2.010207852
          0.652696441	0.611788715	0.592507252	0.650213683	0.642336711	0.584882445	0.657237707	0.754272175	0.831912369	0.837131126	1.059919692	0.947581073	1.873380126	1.821079502	1.888568866	1.847308513	1.917899419	1.872043537	1.800736859	2.309774832
          0.618386745	0.588522428	0.575009496	0.633843732	0.622433443	0.56634475	0.631524575	0.712642604	0.774942893	0.818724925	1.019356472	0.912164041	1.843467359	1.785341645	1.855494077	1.799768631	1.77299769	1.779319758	1.699271291	1.826690591	2.209581887
          0.615529088	0.583183785	0.570089016	0.619564774	0.611366556	0.562363777	0.615579297	0.711376273	0.77921469	0.802175697	1.011938634	0.906107257	1.798889344	1.749899058	1.823549548	1.756510498	1.74145655	1.747938805	1.662263137	1.803297212	1.751008035	2.202762986
          0.536887875	0.505613327	0.493389621	0.539349771	0.532078885	0.492239617	0.521819676	0.600462442	0.674683641	0.67446184	0.837398139	0.768794088	1.442377541	1.420264179	1.46435001	1.422579806	1.410560773	1.411371444	1.367700406	1.46661518	1.405189645	1.413750064	1.452238578'

m <- getCov(lower, names = c("q26q1", "q26q2", "q26q3", "q26q4", "q26q5", "q26q6", #stigma
                             "q17q1", "q17q2", "q17q3", "q17q4", "q17q5", "q19", #care
                             "q29q1", "q29q2", "q29q3", "q29q4", "q29q5", "q29q6", "q29q7", "q29q8", "q29q9", "q29q10", "q29q11" # psy distress
                             ))


#---------------------------------------------------------------
#-------------------3. Estimate the model-----------------------
#---------------------------------------------------------------

#Fit the model
model_mma <- '
#measurement model
SS =~ q26q1 + q26q2 + q26q3 + q26q4 + q26q5 + q26q6
CARE =~ q17q1 + q17q2 + q17q3 + q17q4 + q17q5 + q19
PD =~ q29q1 + q29q3 + q29q4 + q29q5 + q29q6 + q29q7 + q29q8 + q29q9 + q29q10 + q29q11

#outcome model
SS ~ c*CARE + b*PD

#mediator model
PD ~ a*CARE

#IDE
PD_IDE := a*b

#total effect
total := c + (a*b)
'
fit <- sem(model_mma, sample.cov = m,
           sample.nobs = 3940)

#Estimate the model
summary(fit, fit.measures = TRUE, standardized = TRUE, rsquare = TRUE)

#Generate bootstrap CIs
boot.fit <- parameterEstimates(fit, boot.ci.type = "bca.simple")

#Define a convenient layout for the path diagram
lay <- get_layout("CARE", "", "", "", "SS",
                  "", "", "PD", "", "", rows = 2)

#Plot the path diagram and visualize it
graph_sem(model = fit, layout = lay)

#Testing reliability of the latent variables
reliability(fit, return.total = TRUE)